# Обновление функционала Hysteria Installer

## Новые возможности

### 1. Поддержка доменных имен
Теперь можно использовать не только IP адрес, но и доменное имя для подключения к серверу.

**При установке:**
```
Выберите тип адреса сервера:
  1) IP адрес
  2) Доменное имя
Ваш выбор [1-2]: 2
Введите доменное имя (например, vpn.example.com): vpn.mydomain.com
```

**Преимущества:**
- Более удобное запоминание адреса
- Возможность смены IP без изменения конфигурации клиентов
- Профессиональный вид URL подключения

### 2. Выбор типа SSL сертификата

При установке теперь можно выбрать между двумя вариантами:

#### Самоподписанный сертификат (опция 1)
- Создается автоматически за секунды
- Идеально для тестирования и личного использования
- Клиенты должны использовать `insecure=1` в URL

#### Собственный SSL сертификат (опция 2)
- Используйте свой Let's Encrypt или коммерческий сертификат
- Более безопасно для продакшена
- Не требует `insecure=1` в URL

**Пример установки с собственным сертификатом:**
```bash
Выберите тип SSL сертификата:
  1) Самоподписанный сертификат (быстро, для тестирования)
  2) Собственный SSL сертификат (рекомендуется для продакшена)
Ваш выбор [1-2]: 2
Введите путь к файлу сертификата (.crt/.pem): /etc/letsencrypt/live/vpn.example.com/fullchain.pem
Введите путь к приватному ключу (.key): /etc/letsencrypt/live/vpn.example.com/privkey.pem
✓ SSL сертификат успешно настроен
```

### 3. Обязательный ввод учетных данных

**Для пользователя Hysteria:**
При установке вы должны создать учетную запись:
```
Введите имя пользователя: john
Введите пароль (минимум 8 символов): ********
Подтвердите пароль: ********
✓ Пользователь создан: john
```

**Требования к паролю:**
- Минимум 8 символов
- Подтверждение при вводе
- Имя пользователя: только буквы, цифры, _ и -

**Для администратора веб-панели:**
```
Создайте учетную запись администратора:
Введите логин администратора: admin_user
Введите пароль (минимум 8 символов): ********
Подтвердите пароль: ********
```

**Безопасность:**
- Больше нет дефолтных admin/admin
- Уникальные учетные данные для каждой установки
- Минимальные требования к сложности пароля

### 4. Автоматическое определение параметров

Скрипт автоматически:
- Определяет внешний IP если не используется домен
- Сохраняет тип сертификата (insecure флаг)
- Обновляет настройки в базе данных веб-панели
- Генерирует правильные URL подключения

## Изменения в веб-панели

### Новое поле в настройках
В разделе "Настройки" добавлено поле **"Тип SSL сертификата"**:
- Самоподписанный (insecure=1)
- Доверенный SSL сертификат

Это влияет на генерацию URL подключения и QR-кодов.

### Поддержка доменных имен
Поле "IP адрес сервера" теперь можно использовать и для домена:
- Введите IP: `45.67.89.123`
- Или домен: `vpn.example.com`

## Формат URL подключения

### Старый формат (фиксированный):
```
hysteria2://[password]@[ip]:443/?insecure=1#HysteriaUser
```

### Новый формат (гибкий):
```
hysteria2://[password]@[address]:443/?insecure=[0|1]#[username]
```

**Примеры:**

С IP и самоподписанным сертификатом:
```
hysteria2://MySecurePass123@45.67.89.123:443/?insecure=1#john
```

С доменом и доверенным сертификатом:
```
hysteria2://MySecurePass123@vpn.example.com:443/?insecure=0#john
```

## Миграция с предыдущей версии

Если у вас уже установлена панель:

1. **Обновите адрес в веб-панели:**
   - Зайдите в "Настройки"
   - Укажите IP или домен в поле "IP адрес сервера"
   - Выберите тип сертификата
   - Сохраните

2. **Или выполните в терминале:**
```bash
cd /opt/hysteria-ui
source venv/bin/activate
python3 -c "
import sqlite3
conn = sqlite3.connect('hysteria.db')
c = conn.cursor()

# Установите ваш домен или IP
c.execute(\"UPDATE settings SET value='vpn.example.com' WHERE key='server_ip'\")

# Установите тип сертификата (1 для самоподписанного, 0 для доверенного)
c.execute(\"INSERT OR REPLACE INTO settings (key, value) VALUES ('insecure_flag', '0')\")

conn.commit()
conn.close()
print('Настройки обновлены')
"
deactivate
```

3. **Перезапустите веб-панель:**
```bash
systemctl restart hysteria-ui
```

## Пример полной установки

```bash
sudo bash hysteria_installer.sh

# Выбираем опцию 1 - Установка Hysteria

╔═══════════════════════════════════════════════════════════════╗
║              Настройка Hysteria v2 сервера                    ║
╚═══════════════════════════════════════════════════════════════╝

Выберите тип адреса сервера:
  1) IP адрес
  2) Доменное имя
Ваш выбор [1-2]: 2
Введите доменное имя: vpn.mydomain.com
✓ Использование домена: vpn.mydomain.com

Выберите тип SSL сертификата:
  1) Самоподписанный сертификат (быстро, для тестирования)
  2) Собственный SSL сертификат (рекомендуется для продакшена)
Ваш выбор [1-2]: 2
Введите путь к файлу сертификата: /etc/letsencrypt/live/vpn.mydomain.com/fullchain.pem
Введите путь к приватному ключу: /etc/letsencrypt/live/vpn.mydomain.com/privkey.pem
✓ SSL сертификат успешно настроен

═══════════════ Создание пользователя Hysteria ═══════════════
Введите имя пользователя: myuser
Введите пароль (минимум 8 символов): ********
Подтвердите пароль: ********
✓ Пользователь создан: myuser

[... установка ...]

═══════════════ Настройка администратора веб-панели ═══════════════
Создайте учетную запись администратора:
Введите логин администратора: myadmin
Введите пароль (минимум 8 символов): ********
Подтвердите пароль: ********

═══════════════ Доступ к веб-панели ═══════════════
URL:         http://vpn.mydomain.com:54321
Логин:       myadmin
Пароль:      [установлен вами]
═══════════════════════════════════════════════════
```

## Итоги улучшений

✅ Поддержка доменных имен вместо только IP  
✅ Выбор между самоподписанным и собственным SSL сертификатом  
✅ Обязательное создание уникальных учетных данных  
✅ Более безопасная установка по умолчанию  
✅ Гибкая настройка через веб-панель  
✅ Правильная генерация URL с учетом всех параметров  

## Технические детали

### Файлы конфигурации:
- `/etc/hysteria/server_address.txt` - адрес сервера (IP или домен)
- `/etc/hysteria/insecure_flag.txt` - тип сертификата (0 или 1)
- `/etc/hysteria/connection_info.txt` - информация для подключения

### База данных веб-панели:
Новое поле в таблице `settings`:
- `insecure_flag` - тип SSL сертификата ('0' или '1')

### Валидация:
- Доменные имена проверяются regex паттерном
- Пароли требуют минимум 8 символов
- Имена пользователей ограничены [a-zA-Z0-9_-]
